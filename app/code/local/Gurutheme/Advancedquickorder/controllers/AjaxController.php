<?phpclass Gurutheme_Advancedquickorder_AjaxController extends Mage_Core_Controller_Front_Action {    public function loadproductAction() {        echo Mage::helper('advancedquickorder')->getProductHtml();    }        public function suggestAction()    {        $rowcount = 0;        $catid = $this->getRequest()->getParam('catid');        $category = Mage::getModel('catalog/category')->load($catid);        $visibility = array(Mage_Catalog_Model_Product_Visibility::VISIBILITY_BOTH, Mage_Catalog_Model_Product_Visibility::VISIBILITY_IN_CATALOG);        $product_model = Mage::getModel('catalog/product');        if($catid ==  Mage::app()->getStore()->getRootCategoryId())        {            $product_collection = $product_model->getCollection();        } else {            $product_collection = $category->getProductCollection();        }                $product_collection = $product_collection                    ->addStoreFilter(Mage::app()->getStore()->getId())                    ->addAttributeToFilter('visibility', $visibility)                    ->addAttributeToFilter('product_suggestion', array('eq' => 1))                    ->addAttributeToFilter('type_id', array(                                                            'in' => array(                                                                    Mage_Catalog_Model_Product_Type::TYPE_SIMPLE,                                                                    Mage_Catalog_Model_Product_Type::TYPE_CONFIGURABLE,                                                            )                                               ))                    ->setOrder('name', 'asc');        ?>                <?php if(Mage::helper('advancedquickorder')->_getStoreConfig('suggestion/active') == 1):?>                                                        <?php if(count($product_collection)):?>                                    <thead>                                        <tr>                                            <th style="width: 90px;">SKU</th>                                            <th style="width: 145px;">Product Image</th>                                            <th style="width: 335px;">Product Name</th>                                            <th style="width: 40px;">Qty</th>                                            <th style="width: 60px;">Unit Price</th>                                            <th style="width: 60px;">Sub Total</th>                                            <th style="width: 80px;">Action</th>                                        </tr>                                    </thead>                                    <tbody>                                        <?php $num = 1; foreach($product_collection as $suggestion_product):?>                                        <?php $rowcount++; ?>                                        <?php $_suggest_product = Mage::getModel('catalog/product')->load($suggestion_product->getId()); ?>                                        <tr class="<?php echo $num % 2 == 0 ? 'odd' : 'even';?>" id="product_<?php echo $rowcount; ?>">                                            <td id="sku<?php echo $_suggest_product->getProductId()?>" class="txt-sku"><?php echo $_suggest_product->getSku()?></td>                                            <td class="td-pcode">                                                <img width="50" height="50" src="<?php echo Mage::helper('catalog/image')->init($_suggest_product, 'image')->resize(50)?>">                                            </td>                                            <td style="width:335px" class="pname">                                                <label><?php echo $_suggest_product->getName()?></label>                                                <?php if($_suggest_product->getOptions()):?>                                                    <?php $_options = Mage::helper('advancedquickorder')->_getProductOptions($_suggest_product,'product_' . $rowcount, 'options') ?>                                                    <?php echo $_options;?>                                                <?php endif;?>                                                <?php if($_suggest_product->isConfigurable()):?>                                                    <?php $_options = Mage::helper('advancedquickorder')->_getProductOptions($_suggest_product,'product_' . $rowcount, 'configurable') ?>                                                    <?php echo $_options?>                                                <?php endif;?>                                            </td>                                                                                        <td style="width: 40px;" class="td-qty"><input type="text" class="txt-qty" id="qty<?php echo $rowcount; ?>"></td>                                            <td style="width: 60px;" id="product-price-product_<?php echo $rowcount; ?>" class="pqty"><?php echo Mage::helper("core")->currency($_suggest_product->getFinalPrice(), true, false)?></td>                                            <td style="width: 60px;" id="product-sub-total-product_<?php echo $rowcount; ?>" class="pst"><?php echo Mage::helper("core")->currency($_suggest_product->getFinalPrice(), true, false)?></td>                                                                                        <td class="td-action">                                                                                                <?php if(!Mage::helper('advancedquickorder')->_getStoreConfig('general/hideaddtocartonitem')== 1):?>                                                     <button  alt="<?php echo $_suggest_product->getId()?>" class="btn-addcart button"><span><span>Add to Cart</span></span></button>                                                <?php else: ?>                                                    <button style="display: none;" alt="<?php echo $_suggest_product->getId()?>" class="btn-addcart button"><span><span>Add to Cart</span></span></button>                                                <?php endif; ?>                                                                                                    <button class="btn-remove-suggest button"><span><span>Remove</span></span></button>                                                <input type="hidden" class="clear-suggestion" />                                            </td>                                        </tr>                                        <?php $num++; endforeach;?>                                    </tbody>                            <?php endif;?>                        <?php endif;?>                        <script>                                rowcount = <?php echo $rowcount; ?>;                        </script>            <?php            }    public function addtocartAction() {        $params = $this->getRequest()->getParam('params');        $result = $this->_addToCart($params);        $this->getResponse()->setHeader('Content-type', 'application/json');        $this->getResponse()->setBody(Mage::helper('core')->jsonEncode($result));    }    public function loadproductoptionAction() {                $method = $this->getRequest()->getParam('method');        $pid = $this->getRequest()->getParam('productid');        $rowid = $this->getRequest()->getParam('rowid');        $item = Mage::getModel('catalog/product')->load($pid);                Mage::register('product', $item);                Mage::register('rowid', $rowid);                $this->loadLayout();        $html = '';        $block = $this->getLayout()->getBlock('advancedquickorder.product.info.options')               ->setRowId($rowid)               ->setProduct($item);                $html .=   $block->toHtml();                if($item->isConfigurable())        {                        $html .= $this->getLayout()->getBlock('advancedquickorder.product.info.configurable')            ->setRowId($rowid)            ->setProduct($item)            ->toHtml();        }                   echo $html;    }        public function loadfinalpriceAction()    {        $pid = $this->getRequest()->getParam('productid');        $_product = Mage::getModel('catalog/product')->load($pid);        $qty = $this->getRequest()->getParam('qty');        $price = Mage::getModel('catalog/product_type_price');        $unitprice = Mage::helper("core")->currency($price->getFinalPrice($qty, $_product), true, false);        $subtotal = Mage::helper("core")->currency($qty * $price->getFinalPrice($qty, $_product), true, false);        echo $unitprice . ';' . $subtotal;    }    public function _addToCart($params) {        $result = array();        $num = 0;        $cart = Mage::getSingleton('checkout/cart');        foreach ($params as $param) {            $cart_params = array(                'product' => $param['pid'],                'related_product' => null,                'qty' => $param['qty'],            );            if($param['options']){                $cart_params['options'] = $param['options'];            }            if($param['super_attribute']){                $cart_params['super_attribute'] = $param['super_attribute'];            }            $productmodel = Mage::getModel('catalog/product');            $productmodel->load($param['pid']);                        if($productmodel->getTypeId() == "configurable"){                  $childProduct = Mage::getModel('catalog/product_type_configurable')->getProductByAttributes($param['super_attribute'], $productmodel);                if($childProduct)                {                    $cart_params['product'] = $childProduct->getId();                    $childProduct = Mage::getModel('catalog/product')->load($childProduct->getId());                }            }                        $result['products'][$num]['name'] = $productmodel->getName();            try {                                $cart->addProduct($productmodel, $cart_params);                                $result['products'][$num]['status'] = 'success';                if (count($params) == 1) {                    $cart->save();                    $cur_cart = Mage::getModel('checkout/cart')->getQuote()->getData();                    $result['products'][$num]['total'] = Mage::helper('checkout')->formatPrice(Mage::getModel('checkout/cart')->getQuote()->getGrandTotal());                    $result['products'][$num]['count'] = (int) $cur_cart['items_qty'];                }            } catch (Exception $e) {                $result['products'][$num]['status'] = 'error';            }            $num++;        }        if (count($params) > 1) {            try {                $cart->save();                Mage::getSingleton('checkout/session')->setCartWasUpdated(true);            }catch (Exception $e) {            }            $cur_cart = Mage::getModel('checkout/cart')->getQuote()->getData();            $result['total'] = Mage::helper('checkout')->formatPrice(Mage::getModel('checkout/cart')->getQuote()->getGrandTotal());            $result['count'] = (int) $cur_cart['items_qty'];        }        return $result;    }}